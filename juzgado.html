<html><head>
    <meta charset="UTF-8">
    <title>Juzgado Vial</title>
    <link rel="icon" href="logo.png" type="image/png">
 
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <style>
    :root {
      --primary-blue: #00BCD4;
      --secondary-blue: #0097A7;
      --primary-green: #4CAF50;
      --secondary-green: #388E3C;
      --primary-orange: #FF9800;
      --secondary-orange: #F57C00;
    }
    
    /* Estilos generales */
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f0f2f5;
    }
    
    .container {
        max-width: 1100px;
        margin: 0 auto;
        
    }
    
    .header {
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        color: white;
        padding: 20px;
        text-align: center;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    
    .search-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        max-width: 80%;
        margin-left: auto;
        margin-right: auto;
    }
    
    .search-container .form-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .search-container input {
        flex: 1;
    }
    
    .search-container button {
        margin-top: 0;
    }
    
    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .tab-button {
        padding: 10px 20px;
        border: none;
        background: var(--primary-orange);
        color: white;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
    }
    
    .tab-button:hover {
        background: var(--secondary-orange);
    }
    
    .tab-button.active {
        background: var(--secondary-blue);
    }
    
    .form-container {
    width: 100%;
    padding: 20px;             /* espacio interno para que no quede pegado */
    border: 2px solid #dbdbdb; /* borde azul (podés cambiar el color) */
    border-radius: 8px;        /* bordes redondeados */
    background-color: #ffffff; /* color de fondo claro para resaltar */
    box-sizing: border-box;    /* para que el padding no aumente el ancho */
    margin: 10px 0;            /* margen arriba y abajo para separar */
}

    
    
    .form-group {
        margin-bottom: 20px;
        max-width: 100%;
    }
    
    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    input, select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    
    button {
        background: var(--primary-green);
        color: white;
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    button:hover {
        background: var(--secondary-green);
    }
    
    .edit-button {
        background: #2196F3;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .edit-button:hover {
        background: #1976D2;
    }
    
    .delete-button {
        background: #dc3545;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 5px;
    }
    
    .delete-button:hover {
        background: #c82333;
    }
    
    .table-container {
        width: 100%;
        margin-top: 40px;
        overflow-x: auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
   


/* Además, para pantallas pequeñas podemos ajustar el padding y márgenes */
@media (max-width: 600px) {
    .table-container {
        padding: 8px 5px; /* menos padding en horizontal */
        margin-top: 20px; /* opcional para reducir espacio vertical */
    }
}

    
    table {
        width:100%;
        border-collapse: collapse;
    }
    
    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    th {
        background: var(--primary-blue);
        color: white;
        margin: 10px 0;
    }
    
    .export-buttons {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }
    
    /* Add to existing CSS */
    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
    }
    
    .participante-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: flex-start;
    }
    
    .participante-row input {
        flex: 1;
    }
    
    .remove-participante {
        background: #dc3545;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .secondary-button {
        background: var(--primary-blue);
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
    }
    .secondary-button1 {
        background: var(--primary-orange);
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
    }
    
    .participantes-list {
        font-size: 0.9em;
        color: #666;
        margin-top: 5px;
    }
    
    
    /* Update responsive CSS */
    @media (max-width: 768px) {
        .container {
            padding: 10px;
        }
        
        .tabs {
            flex-direction: column;
        }
        
        .form-container,
        .search-container {
            max-width: 95%;
        }
        
        .search-container .form-group {
            flex-direction: column;
            gap: 15px;
        }
    
        .form-row {
            flex-direction: column;
            gap: 15px;
        }
        
        .search-container button {
            width: 100%;
        }
        
        .export-buttons {
            flex-direction: column;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            font-size: 14px;
        }
    }
    
    /* Additional table responsiveness */
    @media (max-width: 480px) {
        th, td {
            padding: 8px;
            font-size: 12px;
        }
        
        .header h1 {
            font-size: 24px;
        }
    }
    
    .table-container a {
        color: #2196F3;
        text-decoration: none;
        margin-right: 5px;
    }
    
    .table-container a:hover {
        text-decoration: underline;
    }
    
    .table-container td:last-child {
        white-space: nowrap;
    }
    
  /* Estilos de fila según el estado */
#accidentesTable tbody tr.finalizado {
    background-color: #b3d4fc; /* azul más intenso */
}

#accidentesTable tbody tr.en-proceso {
    background-color: #fff5ba; /* amarillo pastel */
}

#accidentesTable tbody tr.informe {
    background-color: #b6f5d2; /* verde agua más vivo */
}

#accidentesTable tbody tr.pre-correo {
    background-color: #f4d1ff; /* violeta pastel */
}

#accidentesTable tbody tr.para-la-firma {
    background-color: #e0e0e0; /* gris suave */
}

#accidentesTable tbody tr.requerimiento {
    background-color: #ffd9a6; /* naranja pastel */
}

#accidentesTable tbody tr.esperando-cedula {
    background-color: #fff1a8; /* amarillo medio */
}

#accidentesTable tbody tr.esperando-apremio {
    background-color: #aee4ff; /* celeste medio */
}

#accidentesTable tbody tr.apremio {
    background-color: #ff9fa3; /* rojo suave más fuerte */
}

#accidentesTable tbody tr.pagado {
    background-color: #6fcf6f; /* verde agradable más oscuro */
}

#accidentesTable tbody tr.plan-de-pago {
    background-color: #a8f0ff; /* celeste pastel */
}

#accidentesTable tbody tr.archivo {
    background-color: #e6e6e6; /* gris claro */
}

#accidentesTable tbody tr.extranjero {
    background-color: #ffe0b2; /* durazno pastel */
}

#accidentesTable tbody tr.clausura {
    background-color: #ffb3b3; /* rojo rosado */
}

#accidentesTable tbody tr.apelado {
    background-color: #baf5c1; /* verde menta */
}

#accidentesTable tbody tr.infodata {
    background-color: #c8e6ff; /* azul suave */
}

    
    .alcoholemia-alert {
        color: red;
        font-weight: bold;
    }
    
    .pay-button {
        background: #4CAF50;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .payment-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .payment-content {
        background: white;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .payment-details {
        margin: 20px 0;
    }
    
    .payment-form {
        border: 1px solid #ddd;
        padding: 20px;
        margin: 20px 0;
    }
    
    .payment-total {
        font-size: 24px;
        font-weight: bold;
        margin: 20px 0;
    }
    
    .print-button {
        background: #2196F3;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
    }
    
    .barcode-container {
        text-align: center;
        margin: 20px 0;
        padding: 10px;
        background: white;
    }
    
    .barcode-container svg {
        max-width: 100%;
    }
    
    @media print {
        body * {
            visibility: hidden;
        }
        .payment-content, .payment-content * {
            visibility: visible;
        }
        .payment-content {
            position: absolute;
            left: 0;
            top: 0;
        }
        .payment-form, .print-button, .payment-content > button:last-child {
            display: none !important;  
        }
        .barcode-container {
            display: block !important;
            visibility: visible !important;
            margin-bottom: 30px;
        }
     
    }
    
    #montoAPagar {
        font-size: 24px;
        font-weight: bold;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
    }
    .boton{
        margin-top: 10px;
    }
    .alerta-audiencia {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: white;
  color: #1A2A4A; /* texto oscuro */
  padding: 20px 20px 20px 90px; /* espacio para el robot a la izquierda */
  border-radius: 15px;
  border: 3px solid #00aaff; /* borde celeste */
  box-shadow: 0 0 20px rgba(0, 170, 255, 0.4);
  font-size: 16px;
  z-index: 1000;
  max-width: 300px;
  animation: aparecer 1s ease-in-out;
  display: flex;
  align-items: center;
  gap: 15px;
  font-family: Arial, sans-serif;
  position: fixed;
}

.cerrar-btn {
  position: absolute;
  top: 5px;
  right: 8px;
  background: none;
  color: #00aaff; /* celeste */
  border: none;
  font-size: 22px;
  font-weight: bold;
  cursor: pointer;
  transition: color 0.3s ease;
  padding: 0;
  line-height: 1;
}

.cerrar-btn:hover {
  color: #0077cc;
}

/* Contenedor para el robot a la izquierda */
.robot-icon {
  position: absolute;
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
  width: 50px;
  height: 50px;
}

.tab-button {
  text-decoration: none; /* quita subrayado */
}
th {
  background:  #0097A7;
  color: white;
  margin: 10px 0;
}

    </style>
    
    <div class="container">
        <div class="header">
            <h3>Juzgado Vial Zona Este</h3>
        </div>
    
        <div class="search-container">
            <h2>Buscar Accidente</h2>
            <div class="form-group">
              <input type="text" id="searchInput" placeholder="Ingrese DNI, N° Accidente,Dominio o Estado">
              <button class="bg-success" onclick="buscarRegistros()">Buscar</button>
            </div>
            <div id="searchResults"></div>
          </div>
    
          <div class="tabs">
            <button class="tab-button active ">Accidentes Viales</button>
            <a href="notificaciones.html" class="tab-button text-center ">Generar Notificaciones</a>
            <a href="analisis.html" class="tab-button bg-success text-center ">Análisis</a>
          </div>
          
          
    
        <div id="accidentes" class="tab-content  ">
            <div class="form-container">
                <h2>Carga de Accidente</h2>
                <form id="accidenteForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Número de Accidente:</label>
                            <input type="text" id="numeroAccidente" required placeholder="01/2025">
                            
                        </div>
                        <div class="form-group">
                            <label>Nombre y Apellido:</label>
                            <input type="text" id="nombreAccidente" required placeholder="Natalia Perez">
                        </div>
                        <div class="form-group">
                            <label>DNI:</label>
                            <input type="text" id="dniAccidente" required placeholder="36222333">
                        </div>
                    </div>
    
                    <div class="form-row">
                      <div class="form-group">
                            <label>Fecha del Accidente:</label>
                            <input type="date" id="fechaAccidente" required>
                        </div>
                        <div class="form-group">
                          <label>Marca - Dominio:</label>
                          <input type="text" id="dominioAccidente" required placeholder="Gol Trend AAA987">
                      </div>
                        
                        <div class="form-group">
                            <label>Lugar del Hecho:</label>
                            <input type="text" id="lugarAccidente" required placeholder=" Ruta 50 N° 1500 ,Rodeo del Medio">
                        </div>
                        
                    </div>
    
                    <div class="form-row">
                      <div class="form-group">
                        <label>Fecha de Audiencia:</label>
                        <input type="date" id="fechaAudiencia" required>
                    </div>
                        <div class="form-group">
                          <label>Hora de la Audiencia:</label>
                          <input type="time" id="horaAudiencia" required>
                        </div>
                        <div class="form-group">
                          <label>Asignada a:</label>
                          <select id="asignadaA">
                              <option>Ivan</option>
                              <option>Hugo</option>
                              <option>Daniel</option>
                              <option>Marcela</option>
                              <option>Gabriela</option>
                              <option></option>
                          </select>
                      </div>
                    </div>
    
                    <div class="form-row">
                        
                        <div class="form-group">
                            <label>Tipo de Accidente:</label>
                            <select id="tipoAccidente">
                                <option>Comun</option>
                                <option>Emplace</option>
                                <option>Archivo</option>
                                <option>Clausura</option>
                            </select>
                        </div>
                        <div class="form-group">
                          <label>Estado del Accidente:</label>
                          <select id="estadoAccidente">
                            <option>Finalizado</option>
                            <option>En proceso</option>
                            <option>Informe</option>
                            <option>Pre-correo</option>
                            <option>Para la Firma</option>
                            <option>Requerimiento</option>
                            <option>Esperando Cedula</option>
                            <option>Esperando Apremio</option>
                            <option>Apremio</option>
                            <option>Pagado</option>
                            <option>Plan de Pago</option>
                            <option>Archivo</option>
                            <option>Extranjero</option>
                            <option>Clausura</option>
                            <option>Archivo</option>
                            <option>Apelado</option>
                            <option>Infodata</option>
                          </select>
                      </div>
                      <div class="form-group">
                        <label>Alcohol:</label>
                        <select id="alcohol">
                            <option>NO</option>
                            <option>SI</option>
                            
                        </select>
                    </div>

                      <div class="form-group">
                        <label>Firmado por:</label>
                        <select id="firma">
                            <option>Hugo</option>
                            <option>Carolina</option>
                            <option>Patricia</option>
                        </select>
                    </div>
                    </div>
    
                    <div class="form-row">
                      <div class="form-group">
                        <label>Valor de la Multa:</label>
                        <input type="number" id="valorMultaAccidente" required placeholder=" Sin $ - 1000">
                    </div>

                        <div class="form-group">
                            <label>Fallo (PDF):</label>
                            <input type="file" id="falloPdf" accept=".pdf">
                        </div>
                        
                    </div>
    
                    <div class="form-group">
                        <div class="button-group ">
                        <label>Participantes Adicionales:</label>
                        <div id="participantesContainer"></div>
                        <button type="button" id="btnAgregarParticipante" class="tab-button active">+ Agregar Participante</button>
                        <button class="text-center secondary-button1" type="submit">Guardar Accidente</button>
                     </div>
                      </div>
                      
    
                    

                    
                </form>
            </div>
         </div>
         </div>
         
         <div class="container-fluid" style="height: 98vh">
          <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-8 table-container" >
        
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="mb-0">Registro de Accidentes</h2>
                <div class="input-group input-group-sm w-auto mb-3">
                  <input type="text" id="filtroAccidentes" class="form-control" placeholder="Buscar...">
                  <button id="btnBuscarAccidente" class="btn btn-success btn-sm">Buscar</button>
                  <button id="btnVolver" class="btn btn-outline-primary tab-button btn-sm d-none">Volver</button>
                </div>
              </div>
        
              <div style="overflow-y: auto; max-height: 75vh; ">
                <table id="accidentesTable" class="">
                  <thead class="">
                    <tr>
                      <th style="position: sticky; top: 0; z-index: 1;">Número Accidente</th>
                      <th style="position: sticky; top: 0; z-index: 1;">Nombre Apellido</th>
                      <th style="position: sticky; top: 0; z-index: 1;">DNI</th>
                      <th style="position: sticky; top: 0; z-index: 1;">Fecha</th>
                      <th style="position: sticky; top: 0; z-index: 1;">Lugar</th>
                      <th style="position: sticky; top: 0; z-index: 1;">Dominio</th>
                      <th style="position: sticky; top: 0; z-index: 1;">Fecha Audiencia</th>
                      <th style="position: sticky; top: 0; z-index: 1;">Asignada</th>
                      <th style="position: sticky; top: 0; z-index: 1;">Tipo</th>
                      <th style="position: sticky; top: 0; z-index: 1;">Estado</th>
                      <th style="position: sticky; top: 0; z-index: 1;">Valor Multa</th>
                      <th style="position: sticky; top: 0; z-index: 1;">Fallo</th>
                      <th style="position: sticky; top: 0; z-index: 1;">Acciones</th>
                    </tr>
                    
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
        
              <button class="btn btn-success mt-2" id="btnExportAccidentes">Exportar Accidentes a Excel</button>
            </div>
          </div>
        </div>
        
        
           
        <!-- Alerta visual -->
<div id="alertaAudiencia" class="alerta-audiencia" style="display:none;">
  <button id="cerrarAlerta" class="cerrar-btn" aria-label="Cerrar alerta">✖</button>
  <div class="alerta-contenido">
   
    <div class="alerta-titulo">¡Hoy tenemos audiencias...!</div>
    <ul id="listaAudiencias"></ul>
  </div>
</div>

<!-- Sonido -->
<audio id="alertaSonido" src="https://cdn.pixabay.com/audio/2021/08/04/audio_15d0178e27.mp3" preload="auto"></audio>


<style>
  .alerta-audiencia {
    position: fixed;
    bottom: 20px;
    right: 30px;
    background: #ffffff;
    color: #1A2A4A;
    padding: 15px 18px;
    border-radius: 12px;
    border: 2px solid #022f45;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    font-size: 13px;
    z-index: 1000;
    width: 270px;
    font-weight: 500;
  }
  
  .alerta-contenido {
    text-align: center;
  }
  
  .alerta-titulo {
    font-size: 15px;
    font-weight: bold;
    margin-bottom: 10px;
    color: #0077cc;
  }
  
  #listaAudiencias {
    margin: 0;
    padding-left: 30px;
    text-align: left;
    max-height: 120px;
    overflow-y: auto;
    color: #0b2240;
    font-size: 13px;
  }
  
  .cerrar-btn {
    position: absolute;
    top: 6px;
    right: 8px;
    background: none;
    color: #ff0000c4;
    border: none;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s ease;
    padding: 0;
    line-height: 1;
  }
  
  .cerrar-btn:hover {
    color: #0077cc;
  }
       
 </style>   


    
    <script type="module">
// app.js (o dentro de < type="module"> en tu HTML)
import * as XLSX from "https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getFirestore, collection, getDocs, query, orderBy,
  addDoc, setDoc, doc, deleteDoc
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

// Tu configuración Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCLhhSoQ9gljKTPvWVZVGI3G8dU9dmi53Y",
  authDomain: "mi-juzgado-447a4.firebaseapp.com",
  projectId: "mi-juzgado-447a4",
  storageBucket: "mi-juzgado-447a4.appspot.com",
  messagingSenderId: "276360645206",
  appId: "1:276360645206:web:e6c016d29d98add7bec9f7"
};

// Inicializar app y Firestore
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let accidentesData = [];
let actasData = [];
let editingId = null;
let editingType = null;

// Funciones


export async function cargarDatos() {
  // Accidentes
  const qAccidentes = query(collection(db, "accidentes"), orderBy("numero"));
  const snapAccidentes = await getDocs(qAccidentes);
  accidentesData = snapAccidentes.docs.map(d => ({ id: d.id, ...d.data() }));

  
  updateTable("accidentes");

}
export async function guardarAccidente(accidente) {
  // Mostrar círculo de carga con letras negras y recuadro más chico
  Swal.fire({
    html: `
      <div style="display: flex; flex-direction: column; align-items: center; color: black;">
        <div id="loader" style="margin-bottom: 15px;"></div>
        <h style="margin: 0; font-size: 1.2em;  font-weight: 600">Guardando...</h>
       
      </div>
    `,
    width: '300px', // Más pequeño que el tamaño normal
    allowOutsideClick: false,
    showConfirmButton: false,
    didOpen: () => {
      Swal.showLoading(); // Muestra el círculo de carga
    }
  });

  // Guardar en Firebase
  if (editingId && editingType === "accidentes") {
    await setDoc(doc(db, "accidentes", editingId), accidente);
  } else {
    await addDoc(collection(db, "accidentes"), accidente);
  }

  // Restablecer variables de edición
  editingId = null;
  editingType = null;

  // Recargar datos
  await cargarDatos();

  // Mostrar mensaje de éxito con botón Aceptar
  Swal.fire({
    icon: 'success',
    title: '¡Accidente guardado!',
    text: 'El registro se ha guardado correctamente.',
    confirmButtonText: 'Aceptar',
    confirmButtonColor: '#4CAF50', // Verde para botón
    color: '#000', // Texto negro
    width: '400px', // Un poco más chico
    allowOutsideClick: false
  });
}




export async function eliminarRegistro(type, id) {
  if (confirm("¿Está seguro que desea eliminar este registro?")) {
    await deleteDoc(doc(db, type, id));
    await cargarDatos();
  }
}
export function editarRegistro(type, id) {
  editingId = id;
  editingType = type;
  let data = type === "accidentes"
    ? accidentesData.find(item => item.id === id)
    : actasData.find(item => item.id === id);
  if (!data) return;

  if (type === "accidentes") {
    document.getElementById("numeroAccidente").value = data.numero || "";
    document.getElementById("nombreAccidente").value = data.nombre || "";
    document.getElementById("dniAccidente").value = data.dni || "";
    document.getElementById("fechaAccidente").value = data.fecha || "";
    document.getElementById("lugarAccidente").value = data.lugar || "";
    document.getElementById("dominioAccidente").value = data.dominio || "";
    document.getElementById("fechaAudiencia").value = data.fechaAudiencia || "";
    document.getElementById("horaAudiencia").value = data.horaAudiencia || "";
    document.getElementById("asignadaA").value = data.asignada || "";
    document.getElementById("tipoAccidente").value = data.tipo || "";
    document.getElementById("estadoAccidente").value = data.estado || "";
    document.getElementById("firma").value = data.firma|| "";
    document.getElementById("alcohol").value = data.alcohol|| "";
    document.getElementById("valorMultaAccidente").value = data.valorMulta || 0;

    const container = document.getElementById("participantesContainer");
    container.innerHTML = "";
    if (data.participantes && data.participantes.length > 0) {
      data.participantes.forEach(p => {
        const div = document.createElement("div");
        div.className = "participante-row";
        div.innerHTML = `
          <input type="text" value="${p.nombre}" class="participante-nombre" required>
          <input type="text" value="${p.dni}" class="participante-dni" required>
          <input type="text" value="${p.dominio}" class="participante-dominio" required>
          <button type="button" onclick="this.parentElement.remove()">×</button>
        `;
        container.appendChild(div);
      });
    }

    // 👇 Esto desplaza hasta el formulario de accidentes
    document.getElementById("accidenteForm").scrollIntoView({
      behavior: "smooth",
      block: "start"
    });

  } else {
    document.getElementById("numeroActa").value = data.numero || "";
    document.getElementById("nombreActa").value = data.nombre || "";
    document.getElementById("dniActa").value = data.dni || "";
    document.getElementById("fechaActa").value = data.fecha || "";
    document.getElementById("dominioActa").value = data.dominio || "";
    document.getElementById("alcoholemiaActa").value = data.alcoholemia || "";
    document.getElementById("tipoInfraccion").value = data.infraccion || "";
    document.getElementById("conSecuestro").value = data.secuestro || "";
    document.getElementById("estadoActa").value = data.estado || "";
    document.getElementById("valorMulta").value = data.valor || 0;
  }
}

// Escuchar el evento solo cuando el DOM esté cargado
document.addEventListener("DOMContentLoaded", () => {
  const btnAgregar = document.getElementById("btnAgregarParticipante");

  if (btnAgregar) {
    btnAgregar.addEventListener("click", () => {
      const container = document.getElementById("participantesContainer");

      const div = document.createElement("div");
      div.className = "participante-row";
      div.innerHTML = `
        <input type="text" placeholder="Nombre" class="participante-nombre" required>
        <input type="text" placeholder="DNI" class="participante-dni" required>
        <input type="text" placeholder="Dominio" class="participante-dominio" required>
        <button type="button" class="btnEliminar">×</button>
      `;

      container.appendChild(div);

      // Agregar funcionalidad al botón eliminar de este participante
      div.querySelector(".btnEliminar").addEventListener("click", () => {
        div.remove();
      });
    });
  }
});



export function updateTable(type) {
  const tableBody = document.getElementById(`${type}Table`).querySelector("tbody");
  tableBody.innerHTML = "";
  const data = type === "accidentes" ? accidentesData : actasData;

  data.forEach(item => {
    const row = tableBody.insertRow();
    if (type === "accidentes") {
      row.className = (item.estado || "").toLowerCase().replace(/ /g, "-");

      row.insertCell().textContent = item.numero || "";

      const nombreCell = row.insertCell();
      nombreCell.textContent = item.nombre || "";
      if (item.participantes?.length) {
        const lista = document.createElement("div");
        lista.className = "participantes-list";
        lista.innerHTML = item.participantes.map(p => p.nombre).join("<br>");
        nombreCell.appendChild(lista);
      }

      const dniCell = row.insertCell();
      dniCell.textContent = item.dni || "";
      if (item.participantes?.length) {
        const lista = document.createElement("div");
        lista.className = "participantes-list";
        lista.innerHTML = item.participantes.map(p => p.dni).join("<br>");
        dniCell.appendChild(lista);
      }

      row.insertCell().textContent = item.fecha || "";
      row.insertCell().textContent = item.lugar || "";

      const dominioCell = row.insertCell();
      dominioCell.textContent = item.dominio || "";
      if (item.participantes?.length) {
        const lista = document.createElement("div");
        lista.className = "participantes-list";
        lista.innerHTML = item.participantes.map(p => p.dominio).join("<br>");
        dominioCell.appendChild(lista);
      }

      row.insertCell().textContent = item.fechaAudiencia || "";
      row.insertCell().textContent = item.asignada || "";
      row.insertCell().textContent = item.tipo || "";
      row.insertCell().textContent = item.estado || "";
      row.insertCell().textContent = item.valorMulta || 0;

      const pdfCell = row.insertCell();
      if (item.fallo) {
        const link = document.createElement("a");
        link.href = "javascript:void(0)";
        link.textContent = "PDF";
        link.onclick = () => {
          const modal = document.createElement("div");
          modal.style.cssText = `
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
          `;
          const closeBtn = document.createElement("button");
          closeBtn.textContent = "×";
          closeBtn.style.cssText = `
            position: absolute; top: 10px; right: 10px;
            background: white; border: none; font-size: 24px;
            cursor: pointer; padding: 5px 10px; border-radius: 5px;
          `;
          closeBtn.onclick = () => modal.remove();

          const viewer = document.createElement("iframe");
          viewer.src = item.fallo;
          viewer.style.cssText = `
            width: 90%; height: 90%; border: none; background: white;
          `;

          modal.appendChild(closeBtn);
          modal.appendChild(viewer);
          document.body.appendChild(modal);
        };
        pdfCell.appendChild(link);
      }
    } else {
      row.className = (item.estado || "").toLowerCase().replace(/ /g, "-");
      Object.values(item).forEach(val => {
        row.insertCell().textContent = val || "";
      });
    }
    function exportToExcelAccidentes() {
  const table = document.getElementById("accidentesTable");
  if (!table) return alert("Tabla de accidentes no encontrada.");

  // Copiar solo el contenido de la tabla
  let tableHTML = table.outerHTML.replace(/ /g, '%20');

  // Crear enlace de descarga
  const downloadLink = document.createElement("a");
  downloadLink.href = `data:application/vnd.ms-excel, ${tableHTML}`;
  downloadLink.download = "accidentes.xls";
  document.body.appendChild(downloadLink);
  downloadLink.click();
  document.body.removeChild(downloadLink);
}

// Esperar que el DOM esté listo y asignar el botón
document.addEventListener("DOMContentLoaded", () => {
  const btnExport = document.getElementById("btnExportAccidentes");
  if (btnExport) {
    btnExport.addEventListener("click", exportToExcelAccidentes);
  }
});

    // Acciones
    const actionsCell = row.insertCell();
    const editBtn = document.createElement("button");
    editBtn.className = "edit-button";
    editBtn.textContent = "Editar";
    editBtn.onclick = () => editarRegistro(type, item.id);
    actionsCell.appendChild(editBtn);

    const delBtn = document.createElement("button");
    delBtn.className = "delete-button";
    delBtn.textContent = "🗑️";
    delBtn.onclick = () => eliminarRegistro(type, item.id);
    actionsCell.appendChild(delBtn);
  });
}




// --- Función de búsqueda ---
export async function buscarRegistros() {
  const searchTerm = document.getElementById("searchInput").value.trim().toLowerCase();
  const resultsDiv = document.getElementById("searchResults");
  resultsDiv.innerHTML = "<p>Buscando...</p>";

  const accidentesSnap = await getDocs(collection(db, "accidentes"));
  const actasSnap = await getDocs(collection(db, "actas"));

  const accidentes = [];
  accidentesSnap.forEach(doc => accidentes.push(doc.data()));

  const actas = [];
  actasSnap.forEach(doc => actas.push(doc.data()));

  const resultadosAccidentes = accidentes.filter(a => 
  a.dni === searchTerm ||
  a.dominio?.toLowerCase() === searchTerm ||
  a.numero === searchTerm ||
  (a.estado && a.estado.toLowerCase() === searchTerm.toLowerCase()) ||
  (a.participantes && a.participantes.some(p =>
    p.dni === searchTerm || p.dominio?.toLowerCase() === searchTerm
  ))
);
 

const resultadosActas = actas.filter(a =>
  a.dni === searchTerm ||
  a.dominio?.toLowerCase() === searchTerm ||
  a.numero === searchTerm ||
  (a.estado && a.estado.toLowerCase() === searchTerm.toLowerCase())
);

  let html = "<h3>Resultados de la búsqueda:</h3>";

  if (resultadosAccidentes.length) {
    html += "";
    resultadosAccidentes.forEach(acc => {
      let participantesText = "";
      if (acc.participantes && acc.participantes.length) {
        participantesText = "<br>Participantes: " + acc.participantes.map(p =>
          `${p.nombre} (DNI: ${p.dni}, Dominio: ${p.dominio})`
        ).join(", ");
      }
      html += `
<p><strong>Accidente: ${acc.numero} - ${acc.nombre} - ${acc.dni}</strong><br>
Estado: <strong>${acc.estado}</strong> - Dominio: ${acc.dominio}<br>
Resolvio: ${acc.asignada} - Audiencia: ${acc.fecha} - Hora: ${acc.horaAudiencia}<br>
Firma: ${acc.firma} - <span style="color:red;">Alcohol: ${acc.alcohol}</span> - Valor Multa: $${acc.valorMulta || 0} <strong>${participantesText}</strong></p>
<button 
    class="pay-button"
    data-numero="${acc.numero}"
    data-nombre="${acc.nombre}"
    data-dni="${acc.dni}"
    data-fecha="${acc.fecha}"
    data-valor="${acc.valorMulta || 0}"
>Pagar</button> 
<button onclick="location.reload()" class="pay-button bg-danger">Cancelar</button>

</p>
`;


    });
  }

  if (resultadosActas.length) {
    html += "<h4>Actas:</h4>";
    resultadosActas.forEach(acta => {
      html += `<p><strong>Acta:</strong> ${acta.numero} - ${acta.nombre} - ${acta.dni}<br>
                Fecha: ${acta.fecha} - Infracción: ${acta.infraccion}<br>
                Valor: $${acta.valor || 0}</p>`;
    });
  }

  if (!resultadosAccidentes.length && !resultadosActas.length) {
    html += "<p>No se encontraron registros.</p>";
  }

  resultsDiv.innerHTML = html;
}

// ✅ Hacer disponible la función al HTML
window.buscarRegistros = buscarRegistros;

// Listeners para formularios, para agregarlos en tu HTML

document.getElementById("accidenteForm").addEventListener("submit", async e => {
  e.preventDefault();

  const participantes = [];
  document.querySelectorAll(".participante-row").forEach(row => {
    participantes.push({
      nombre: row.querySelector(".participante-nombre").value,
      dni: row.querySelector(".participante-dni").value,
      dominio: row.querySelector(".participante-dominio").value
    });
  });

  const falloPdf = document.getElementById("falloPdf").files[0];

  if (falloPdf) {
    const reader = new FileReader();
    reader.onload = async event => {
      const pdfUrl = event.target.result;

      const accidente = {
        numero: document.getElementById("numeroAccidente").value,
        nombre: document.getElementById("nombreAccidente").value,
        dni: document.getElementById("dniAccidente").value,
        fecha: document.getElementById("fechaAccidente").value,
        lugar: document.getElementById("lugarAccidente").value,
        dominio: document.getElementById("dominioAccidente").value,
        fechaAudiencia: document.getElementById("fechaAudiencia").value,
        horaAudiencia: document.getElementById("horaAudiencia").value,
        asignada: document.getElementById("asignadaA").value,
        tipo: document.getElementById("tipoAccidente").value,
        estado: document.getElementById("estadoAccidente").value,
        firma: document.getElementById("firma").value,
        alcohol: document.getElementById("alcohol").value, 
        valorMulta: Number(document.getElementById("valorMultaAccidente").value),
        fallo: pdfUrl,
        participantes: participantes
      };

      await guardarAccidente(accidente);
      e.target.reset();
      document.getElementById("participantesContainer").innerHTML = "";
    };
    reader.readAsDataURL(falloPdf);
  } else {
    const accidente = {
      numero: document.getElementById("numeroAccidente").value,
      nombre: document.getElementById("nombreAccidente").value,
      dni: document.getElementById("dniAccidente").value,
      fecha: document.getElementById("fechaAccidente").value,
      lugar: document.getElementById("lugarAccidente").value,
      dominio: document.getElementById("dominioAccidente").value,
      fechaAudiencia: document.getElementById("fechaAudiencia").value,
      horaAudiencia: document.getElementById("horaAudiencia").value,
      asignada: document.getElementById("asignadaA").value,
      tipo: document.getElementById("tipoAccidente").value,
      estado: document.getElementById("estadoAccidente").value,
      firma: document.getElementById("firma").value,
      alcohol: document.getElementById("alcohol").value,
      valorMulta: Number(document.getElementById("valorMultaAccidente").value),
      fallo: "",
      participantes: participantes
    };
    await guardarAccidente(accidente);
    e.target.reset();
    document.getElementById("participantesContainer").innerHTML = "";
  }
});


document.getElementById('btnExportAccidentes').addEventListener('click', () => {
  const table = document.getElementById('accidentesTable');
  const headers = [];
  const data = [];

  const excludeIndexes = []; // índices de columnas a excluir
  const headerRow = table.querySelector("thead tr");
  const ths = headerRow.querySelectorAll("th");

  // Armar los headers y detectar qué columnas excluir
  ths.forEach((th, index) => {
    const headerText = th.innerText.trim().toUpperCase();
    if (
      headerText === "DNI" ||
      headerText === "NOMBRE APELLIDO" ||
      headerText === "LUGAR" ||
      headerText === "FALLO" ||
      headerText === "ACCIONES"
    ) {
      excludeIndexes.push(index);
    } else {
      headers.push(headerText);
    }
  });

  data.push(headers);

  const rows = table.querySelectorAll("tbody tr");
  rows.forEach(row => {
    const rowData = [];
    const cells = row.querySelectorAll("td");
    cells.forEach((cell, index) => {
      if (!excludeIndexes.includes(index)) {
        rowData.push(cell.innerText.trim());
      }
    });
    data.push(rowData);
  });

  // Crear hoja y exportar
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Accidentes');
  XLSX.writeFile(wb, 'Accidentes_filtrados.xlsx');
});




// Inicializar al cargar DOM
document.addEventListener("DOMContentLoaded", cargarDatos);

// Mostrar alerta si hay audiencias HOY con robot bonito
export async function verificarAudienciasHoy() {
  const hoy = new Date().toISOString().split("T")[0];
  const q = query(collection(db, "accidentes"));
  const snapshot = await getDocs(q);
  let audienciasHoy = [];

  snapshot.forEach(doc => {
    const data = doc.data();
    if (data.fechaAudiencia === hoy && data.asignada) {
      audienciasHoy.push({
        numero: data.numero || "Sin número",
        asignadaA: data.asignada || "Sin asignación"
      });
    }
  });

  if (audienciasHoy.length > 0) {
    const alerta = document.getElementById("alertaAudiencia");
    const lista = document.getElementById("listaAudiencias");
    const sonido = document.getElementById("alertaSonido");

    lista.innerHTML = "";
    audienciasHoy.forEach(item => {
      const li = document.createElement("li");
      li.innerHTML = `<span class='icon'>✅</span> <strong>${item.numero}- <em>${item.asignadaA}</em></strong> `;
      lista.appendChild(li);
    });

    alerta.style.display = "flex";

    sonido.play().catch(() => console.log("No se pudo reproducir el sonido"));

    const btnCerrar = document.getElementById("cerrarAlerta");
    if (btnCerrar) {
      btnCerrar.addEventListener("click", () => {
        alerta.style.display = "none";
      });
    }
  }
}

document.addEventListener("DOMContentLoaded", () => {
  verificarAudienciasHoy();
});
document.getElementById("btnBuscarAccidente").addEventListener("click", () => {
  const estadoSeleccionado = document.getElementById("estadoAccidente").value.trim().toLowerCase();
  const filas = document.querySelectorAll("#accidentesTable tbody tr");

  filas.forEach(fila => {
    const columnaEstado = fila.children[9]; // Columna 10 (índice 9)
    const estadoFila = columnaEstado.textContent.trim().toLowerCase();

    // Si el estado del filtro está vacío, mostramos todo
    if (!estadoSeleccionado) {
      fila.style.display = "";
      return;
    }

    // Comparamos texto estrictamente
    if (estadoFila === estadoSeleccionado) {
      fila.style.display = "";
    } else {
      fila.style.display = "none";
    }
  });
});
  
document.getElementById("btnBuscarAccidente").addEventListener("click", function () {
  const filtro = document.getElementById("filtroAccidentes").value.toLowerCase().trim();
  const tabla = document.getElementById("accidentesTable");
  const filas = tabla.getElementsByTagName("tr");

  for (let i = 1; i < filas.length; i++) {
    const celdas = filas[i].getElementsByTagName("td");
    let encontrado = false;

    for (let j = 0; j < celdas.length; j++) {
      const texto = celdas[j].textContent.toLowerCase();
      if (texto.includes(filtro)) {
        encontrado = true;
        break;
      }
    }

    filas[i].style.display = encontrado ? "" : "none";
  }
});
document.getElementById("btnBuscarAccidente").addEventListener("click", function () {
    const termino = document.getElementById("filtroAccidentes").value.toLowerCase();
    const tabla = document.getElementById("accidentesTable");
    const filas = tabla.getElementsByTagName("tr");

    // Mostrar botón "Volver"
    document.getElementById("btnVolver").classList.remove("d-none");

    for (let i = 1; i < filas.length; i++) {
        let fila = filas[i];
        let textoFila = fila.innerText.toLowerCase();
        fila.style.display = textoFila.includes(termino) ? "" : "none";
    }
});

document.getElementById("btnVolver").addEventListener("click", function () {
    const filas = document.getElementById("accidentesTable").getElementsByTagName("tr");

    // Mostrar todas las filas
    for (let i = 1; i < filas.length; i++) {
        filas[i].style.display = "";
    }

    // Limpiar campo y ocultar botón "Volver"
    document.getElementById("filtroAccidentes").value = "";
    document.getElementById("btnVolver").classList.add("d-none");
});



import { jsPDF } from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/+esm";

async function generarPDF(acc) {
    const doc = new jsPDF();

    // Logo
    const logoBase64 = await fetch("logo.png")
        .then(res => res.blob())
        .then(blob => new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(blob);
        }));

    doc.addImage(logoBase64, "PNG", 15, 10, 20, 20);

    // Títulos
    doc.setFontSize(18);
    doc.setFont("helvetica", "bold");
    doc.text("Municipalidad de Maipú", 105, 15, null, null, "center");

    doc.setFontSize(14);
    doc.text("Juzgado Vial Zona Este", 105, 25, null, null, "center");

    // Línea separadora
    doc.setDrawColor(0);
    doc.setLineWidth(0.5);
    doc.line(15, 32, 195, 32);

    // Datos
    let y = 45;
    doc.setFontSize(12);
    doc.text(`Número de Accidente: ${acc.numero}`, 20, y);
    y += 10;
    doc.text(`Nombre: ${acc.nombre}`, 20, y);
    y += 10;
    doc.text(`DNI: ${acc.dni}`, 20, y);
    y += 10;
    doc.text(`Fecha Audiencia: ${acc.fecha}`, 20, y);
    y += 10;
    doc.text(`Valor Multa: $${acc.valorMulta || 0}`, 20, y);
    y += 10;
    doc.text(`Fecha de Pago: ${new Date().toLocaleDateString()}`, 20, y);

    // QR con link de pago
    const linkPago = "https://mpago.la/XXXXXXXX"; // Cambiar por link real
    const qrURL = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(linkPago)}`;

    const qrImg = await fetch(qrURL)
        .then(res => res.blob())
        .then(blob => new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(blob);
        }));

    // QR centrado y más grande
    const qrX = (210 - 60) / 2; // centrado en A4
    doc.text("Escanee para pagar:", 105, y + 20, null, null, "center");
    doc.addImage(qrImg, "PNG", qrX, y + 25, 60, 60);

    

    // Abrir PDF
    window.open(doc.output("bloburl"), "_blank");
}
// Evento click en botón pagar
document.addEventListener("click", e => {
    if (e.target.classList.contains("pay-button")) {
        Swal.fire({
            title: "Datos del Conductor",
            html: `
                <input id="nombre" class="swa10-input" placeholder="Nombre completo" value="${e.target.dataset.nombre || ''}">
                <input id="dni" class="swal0-input mt-1" placeholder="DNI" value="${e.target.dataset.dni || ''}">
            `,
            confirmButtonText: "Generar comprobante",
            showCancelButton: true,
            cancelButtonText: "Cancelar",
            customClass: {
                confirmButton: 'swal2-confirm btn-confirm-green',
                cancelButton: 'swal2-cancel btn-cancel-red'
            },
            buttonsStyling: false,
            preConfirm: () => {
                const nombre = document.getElementById("nombre").value.trim();
                const dni = document.getElementById("dni").value.trim();
                if (!nombre || !dni) {
                    Swal.showValidationMessage("Debe completar nombre y DNI");
                    return false;
                }
                return { nombre, dni };
            }
        }).then(result => {
            if (result.isConfirmed) {
                const acc = {
                    numero: e.target.dataset.numero,
                    nombre: result.value.nombre,
                    dni: result.value.dni,
                    fecha: e.target.dataset.fecha,
                    valorMulta: e.target.dataset.valor
                };
                generarPDF(acc);

                // Cambiar estado a pagado
                const estadoElemento = e.target.closest("p").querySelector("strong");
                if (estadoElemento) {
                    estadoElemento.textContent = "Pagado";
                    estadoElemento.style.color = "green";
                }
            }
        });
    }
});

// Estilos para botones
document.head.insertAdjacentHTML('beforeend', `
<style>
.btn-confirm-green {
    background-color: #28a745 !important;
    color: white !important;
    padding: 8px 20px !important;
    border-radius: 5px !important;
    font-weight: bold;
    margin-right: 10px !important; /* separación del botón rojo */
}
.btn-cancel-red {
    background-color: #dc3545 !important;
    color: white !important;
    padding: 8px 20px !important;
    border-radius: 5px !important;
    font-weight: bold;
    margin-left: 10px !important; /* separación del botón verde */
}
</style>
`);

    </script>
    


    </body>
    </html>