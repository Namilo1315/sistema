<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Juzgado Vial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="logo.png" type="image/png" />

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      /* Paleta según logo Maipú: azul, verde y naranja */
      --primary:#0a9ad9;     /* azul */
      --primary-2:#53b44c;   /* verde */
      --accent:#f59e0b;      /* naranja */
      --success:#1eb355;
      --danger:#dc2626;
      --bg:#ffffff;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#475569;
      --border:#e5e7eb;
    }

    html,body{ font-size:14px; background:var(--bg); color:var(--text); }
    body{ margin:0; overflow-x:hidden; } /* evita scroll horizontal */

    /* ===== Header ===== */
    .sys-header{
      position: sticky; top:0; z-index:1020;
      background: linear-gradient(90deg, var(--primary), var(--primary-2));
      box-shadow: 0 6px 16px rgba(0,0,0,.18);
    }
    .sys-header .brand{
      display:flex; align-items:center; gap:.6rem; font-weight:800; letter-spacing:.2px; color:#fff; text-decoration:none;
    }
    .sys-header .brand img{
      width:34px; height:34px; border-radius:8px; background:#fff; padding:3px; object-fit:contain;
    }
    .sys-header .nav-link{ color:#eef7ff!important; padding:.75rem 1rem; font-weight:600; }
    .sys-header .nav-link:hover, .sys-header .nav-link.active{ color:#fff!important; }
    .sys-header .btn-accent{ background:var(--accent); color:#1a1a1a; border:none; }
    .sys-header .btn-outline-light-sys{ background:transparent; border:1px solid #ffffffb3; color:#fff; }
    .sys-header .btn-outline-light-sys:hover{ background:#ffffff1a; }

    .header-row{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:1rem;
      padding:.4rem 1rem;
    }
    .header-left{ justify-self:start; }
    .header-center{ justify-self:center; }
    .header-right{ justify-self:end; display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
    .header-right .badge{ font-weight:700; }

    /* Contenedores */
    .container-narrow{ max-width:1100px; margin: 18px auto; padding: 0 16px; }
    .card-elev{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow: 0 6px 20px rgba(2,19,32,.06);
    }

    /* Buscador */
    .search-container{ padding:16px; }
    .search-container h2{ font-size:18px; margin-bottom:10px; }

    /* Formulario */
    .form-container{ padding:20px; margin:10px 0 18px; }
    .form-row{ display:flex; gap:16px; margin-bottom:16px; }
    .form-row .form-group{ flex:1; margin:0; }
    label{ font-weight:600; margin-bottom:6px; }
    input, select{ width:100%; padding:10px; border:1px solid #d6d9df; border-radius:8px; }
    .btn-primary-sys{ background:var(--success); border:none; }
    .btn-primary-sys:hover{ background:#138a3f; }
    .tab-link{ background:#ffc710; color:#0f172a; border:none; border-radius:10px; padding:10px 14px; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .tab-link.active{ background:var(--primary); color:#fff; }

    /* ===== Tabla (full width) ===== */
    .table-container{ padding:16px; }
    .full-bleed{
      /* ocupa todo el ancho sin romper el layout ni generar scroll */
      width:100vw;
      margin-left: calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
    }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:12px; border-bottom:1px solid #eaecef; vertical-align:top; }
    th{ background:linear-gradient(90deg, var(--primary), var(--primary)); color:#fff; position:sticky; top:0; z-index:1; }

    .actions .btn{ padding:4px 8px; }
    .actions .btn-group .btn{ border-radius:6px; } /* que se vean prolijos juntos */

    /* Estado por fila */
    #accidentesTable tbody tr.finalizado{ background:#b3d4fc; }
    #accidentesTable tbody tr.apremio{ background:#ff585e22; }
    #accidentesTable tbody tr.pagado{ background:#6fcf6f33; }
    #accidentesTable tbody tr.archivo{ background:#ffeea2; }

    .participantes-list{ font-size:.86em; color:#6b7280; margin-top:4px; }

    /* Chips */
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-weight:600; font-size:.86em; }
    .chip-muted{ background:#eef2f7; color:#334155; border:1px dashed #cbd5e1; }
    .chip-ok{ background:#def7ec; color:#03543f; }

    /* ===== Toast Audiencias (flotante arriba del contenido) ===== */
    .alerta-audiencia{
      position: fixed; bottom: 20px; right: 24px;
      background:#fff; color:#102a43; border:2px solid var(--primary-2);
      border-radius:12px; padding:14px 18px; width: 290px;
      box-shadow:0 12px 32px rgba(0,0,0,.28);
      z-index: 9999; /* por encima de todo */
      display:none;
    }
    .alerta-titulo{ font-weight:800; color:var(--primary-2); margin-bottom:8px; }
    .cerrar-btn{
      position:absolute; top:6px; right:8px; border:none; background:none; color:#c0392b;
      font-size:18px; font-weight:700; cursor:pointer;
    }
    #listaAudiencias{ max-height: 140px; overflow:auto; margin:0; padding-left:18px; }

    @media (max-width: 992px){
      .form-row{ flex-direction:column; }
      .header-row{ grid-template-columns: 1fr auto; grid-template-areas: "left right" "center center"; }
      .header-left{ grid-area:left; }
      .header-center{ grid-area:center; }
      .header-right{ grid-area:right; justify-self:end; }
    }
    @media (max-width: 600px){
      th,td{ padding:8px; font-size:12px; }
      .alerta-audiencia{ width: 92vw; right:4vw; }
    }
    .header-row{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  align-items:center;
  gap:1rem;
  padding:.4rem 1rem;
}

@media (max-width: 600px){
  .header-row{
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center;
    gap:.5rem;
  }
  .header-left,
  .header-center,
  .header-right{
    justify-self:center;
    width:100%;
    display:flex;
    justify-content:center;
    flex-wrap:wrap;
  }
  .header-center ul.nav{
    flex-direction:row;
    justify-content:center;
    gap:.5rem;
  }
  .header-right{
    gap:.5rem;
    order:2; /* botones en segunda fila */
  }
  .header-center{
    order:3; /* menú en tercera fila */
  }
  .header-left{
    order:1; /* logo en primera fila */
  }
}
.tabs-bar {
  display: flex;
  gap: 10px;
}

@media (max-width: 600px) {
  .tabs-bar {
    justify-content: space-between;
  }
  .tabs-bar .tab-link {
    flex: 1;               /* los tres se reparten el ancho */
    text-align: center;
    font-size: 13px;       /* más chico para que entren */
    padding: 8px 6px;
  }
}


  </style>
</head>
<body>

  <!-- ===== HEADER ===== -->
  <header class="sys-header">
    <div class="header-row">
      <div class="header-left">
        <a href="#" class="brand">
          <img src="logo.png" alt="Logo">
          <span>Juzgado Vial Maipú</span>
        </a>
      </div>
      <nav class="header-center">
        <ul class="nav">
          <li class="nav-item"><a class="nav-link active" href="#"><i class="bi bi-clipboard2-fill"></i> Accidentes</a></li>
          <li class="nav-item"><a class="nav-link" href="notificaciones.html"><i class="bi bi-envelope-paper"></i> Notificaciones</a></li>
          <li class="nav-item"><a class="nav-link" href="analisis.html"><i class="bi bi-graph-up"></i> Análisis</a></li>
        </ul>
      </nav>
      <div class="header-right">
        <span class="badge bg-light text-dark"><i class="bi bi-collection"></i> Total: <span id="totalAccidentes">0</span></span>
        <span class="badge bg-warning text-dark"><i class="bi bi-calendar-event"></i> Audiencias hoy: <span id="audienciasHoyBadge">0</span></span>
        <button id="scrollToForm" class="btn btn-accent btn-sm"><i class="bi bi-plus-lg"></i> Nuevo</button>
        <button id="btnExportAccidentes" class="btn btn-outline-light-sys btn-sm"><i class="bi bi-file-earmark-spreadsheet"></i> Exportar</button>
      </div>
    </div>
    
  </header>

  <div class="container-narrow">

    <!-- Buscador -->
    <div class="card-elev search-container">
      <h2 class="mb-2"><i class="bi bi-search"></i> Buscar Accidente</h2>
      <div class="row g-2 align-items-center">
        <div class="col-12 col-md-8 col-lg-9">
          <input type="text" id="searchInput" class="form-control" placeholder="Ingrese DNI, N° Accidente, Dominio o Estado">
        </div>
        <div class="col-12 col-md-4 col-lg-3 d-grid">
          <button class="btn btn-primary-sys" onclick="buscarRegistros()"><i class="bi bi-search"></i> Buscar</button>
        </div>
      </div>
      <div id="searchResults" class="mt-3"></div>
    </div>

   <!-- Tabs -->
<div class="tabs-bar mb-3 mt-3">
  <a class="tab-link active" href="#"><i class="bi bi-car-front"></i> Accidentes</a>
  <a class="tab-link" href="notificaciones.html"><i class="bi bi-envelope-paper"></i> Notificaciones</a>
  <a class="tab-link" href="analisis.html"><i class="bi bi-graph-up"></i> Análisis</a>
</div>


    <!-- Formulario -->
    <div id="accidentes" class="card-elev form-container">
      <h2 class="mb-3">Carga de Accidente</h2>
      <form id="accidenteForm">
        <div class="form-row">
          <div class="form-group">
            <label>Número de Accidente</label>
            <input type="text" id="numeroAccidente" required placeholder="01/2025">
          </div>
          <div class="form-group">
            <label>Nombre y Apellido</label>
            <input type="text" id="nombreAccidente" required placeholder="Natalia Perez">
          </div>
          <div class="form-group">
            <label>DNI</label>
            <input type="text" id="dniAccidente" required placeholder="36222333">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Fecha del Accidente</label>
            <input type="date" id="fechaAccidente" required>
          </div>
          <div class="form-group">
            <label>Marca - Dominio</label>
            <input type="text" id="dominioAccidente" required placeholder="Gol Trend AAA987">
          </div>
          <div class="form-group">
            <label>Lugar del Hecho</label>
            <input type="text" id="lugarAccidente" required placeholder="Ruta 50 N°1500, Rodeo del Medio">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Fecha de Audiencia</label>
            <input type="date" id="fechaAudiencia" required>
          </div>
          <div class="form-group">
            <label>Hora de la Audiencia</label>
            <input type="time" id="horaAudiencia" required>
          </div>
          <div class="form-group">
            <label>Asignada a</label>
            <select id="asignadaA">
              <option>Ivan</option><option>Hugo</option><option>Daniel</option>
              <option>Marcela</option><option>Gabriela</option><option></option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Tipo de Accidente</label>
            <select id="tipoAccidente">
              <option>Comun</option>
              <option>Emplace</option>
              <option>Archivo</option>
              <option>Clausura</option>
            </select>
          </div>

          <div class="form-group">
            <label>Estado del Accidente</label>
            <select id="estadoAccidente">
              <option>Finalizado</option>
              <option>En proceso</option>
              <option>Informe</option>
              <option>Pre-correo</option>
              <option>Para la Firma</option>
              <option>Requerimiento</option>
              <option>Esperando Cedula</option>
              <option>Esperando Apremio</option>
              <option>Apremio</option>
              <option>Pagado</option>
              <option>Plan de Pago</option>
              <option>Archivo</option>
              <option>Extranjero</option>
              <option>Clausura</option>
              <option>Apelado</option>
              <option>Infodata</option>
            </select>
          </div>

          <div class="form-group">
            <label>Alcohol</label>
            <select id="alcohol">
              <option>NO</option>
              <option>SI</option>
            </select>
          </div>

          <div class="form-group">
            <label>Firmado por</label>
            <select id="firma">
              <option>Hugo</option>
              <option>Carolina</option>
              <option>Patricia</option>
              <option>Sin firmar</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Valor de la Multa</label>
            <input type="number" id="valorMultaAccidente" required placeholder="0 - 1000">
          </div>
          <div class="form-group">
            <label>Fallo (PDF)</label>
            <input type="file" id="falloPdf" accept=".pdf">
          </div>
        </div>

        <div class="mb-2">
          <label class="mb-1">Participantes Adicionales</label>
          <div id="participantesContainer"></div>
          <div class="d-flex gap-2 mt-2">
            <button type="button" id="btnAgregarParticipante" class="btn btn-outline-secondary btn-sm"><i class="bi bi-person-plus"></i> Agregar participante</button>
            <button class="btn btn-primary-sys" type="submit"><i class="bi bi-save2"></i> Guardar Accidente</button>
          </div>
        </div>
      </form>
    </div>

    <!-- ===== Tabla (FULL WIDTH) ===== -->
    <div class="card-elev table-container full-bleed">
      <div class="container-narrow">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="mb-0">Registro de Accidentes</h2>
          <div class="input-group input-group-sm w-auto">
            <input type="text" id="filtroAccidentes" class="form-control" placeholder="Filtrar tabla…">
            <button id="btnBuscarAccidente" class="btn btn-success btn-sm">Buscar</button>
            <button id="btnVolver" class="btn btn-outline-primary btn-sm d-none">Volver</button>
          </div>
        </div>
      </div>

      <div style="overflow-y:auto; max-height: 70vh;">
        <table id="accidentesTable" class="table table-hover">
          <thead>
            <tr>
              <th>Accidente</th>
              <th>Nomb/Apel</th>
              <th>DNI</th>
              <th>Fecha</th>
              <th>Lugar</th>
              <th>Dominio</th>
              <th>Audiencia</th>
              <th>Asignada</th>
              <th>Tipo</th>
              <th>Estado</th>
              <th>Firma</th>
              <th>Multa</th>
              <th>Fallo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div><!-- /container -->

  <!-- Toast Audiencias -->
  <div id="alertaAudiencia" class="alerta-audiencia">
    <button id="cerrarAlerta" class="cerrar-btn" aria-label="Cerrar alerta">✖</button>
    <div class="alerta-contenido">
      <div class="alerta-titulo">¡Hoy tenemos audiencias!</div>
      <ul id="listaAudiencias"></ul>
    </div>
  </div>
  <audio id="alertaSonido" src="https://cdn.pixabay.com/audio/2021/08/04/audio_15d0178e27.mp3" preload="auto"></audio>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ===== APP (ESM) ===== -->
  <script type="module">
    /* ====== IMPORTS (solo ESM, sin compat duplicado) ====== */
    import * as XLSX from "https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs";
    import { jsPDF } from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/+esm";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, orderBy,
      addDoc, setDoc, doc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    /* ====== FIREBASE ====== */
    const firebaseConfig = {
      apiKey: "AIzaSyCLhhSoQ9gljKTPvWVZVGI3G8dU9dmi53Y",
      authDomain: "mi-juzgado-447a4.firebaseapp.com",
      projectId: "mi-juzgado-447a4",
      storageBucket: "mi-juzgado-447a4.appspot.com",
      messagingSenderId: "276360645206",
      appId: "1:276360645206:web:e6c016d29d98add7bec9f7"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ====== STATE ====== */
    let accidentesData = [];
    let editingId = null;
    let editingType = null;
    let editingFallo = ""; // conserva PDF al editar

    /* ====== UI HELPERS ====== */
    function badgeFirma(value){
      if(!value || value.toLowerCase()==="sin firmar"){
        return '<span class="chip chip-muted"><i class="bi bi-pencil-slash"></i> Sin firmar</span>';
      }
      return `<span class="chip chip-ok"><i class="bi bi-check2-circle"></i> ${value}</span>`;
    }

    /* ====== CARGA DATOS ====== */
    async function cargarDatos(){
      const qAccidentes = query(collection(db, "accidentes"), orderBy("numero"));
      const snapAccidentes = await getDocs(qAccidentes);
      accidentesData = snapAccidentes.docs.map(d => ({ id:d.id, ...d.data() }));

      updateTable();

      // métricas header
      document.getElementById("totalAccidentes").textContent = accidentesData.length.toString();

      // audiencias hoy
      const hoy = new Date().toISOString().split("T")[0];
      const countHoy = accidentesData.filter(a => a.fechaAudiencia === hoy).length;
      document.getElementById("audienciasHoyBadge").textContent = countHoy.toString();
    }

    async function guardarAccidente(accidente){
      Swal.fire({
        html:`<div style="display:flex;flex-direction:column;align-items:center;color:#111">
                <div class="spinner-border text-success mb-2" role="status"></div>
                <strong>Guardando…</strong>
              </div>`,
        width:'300px', allowOutsideClick:false, showConfirmButton:false
      });

      if(editingId && editingType==="accidentes"){
        await setDoc(doc(db,"accidentes",editingId), accidente);
      }else{
        await addDoc(collection(db,"accidentes"), accidente);
      }
      editingId=null; editingType=null; editingFallo="";

      await cargarDatos();
      Swal.fire({ icon:'success', title:'¡Accidente guardado!', confirmButtonText:'Aceptar' });
    }

    async function eliminarRegistro(type,id){
      if(confirm("¿Está seguro que desea eliminar este registro?")){
        await deleteDoc(doc(db, type, id));
        await cargarDatos();
      }
    }

    function editarRegistro(type,id){
      editingId = id; editingType = type;
      const data = accidentesData.find(i => i.id===id);
      if(!data) return;

      document.getElementById("numeroAccidente").value = data.numero || "";
      document.getElementById("nombreAccidente").value = data.nombre || "";
      document.getElementById("dniAccidente").value = data.dni || "";
      document.getElementById("fechaAccidente").value = data.fecha || "";
      document.getElementById("lugarAccidente").value = data.lugar || "";
      document.getElementById("dominioAccidente").value = data.dominio || "";
      document.getElementById("fechaAudiencia").value = data.fechaAudiencia || "";
      document.getElementById("horaAudiencia").value = data.horaAudiencia || "";
      document.getElementById("asignadaA").value = data.asignada || "";
      document.getElementById("tipoAccidente").value = data.tipo || "";
      document.getElementById("estadoAccidente").value = data.estado || "";
      const firmaSel = document.getElementById("firma");
      if (![...firmaSel.options].some(o => o.value==="Sin firmar")) {
        firmaSel.insertAdjacentHTML('beforeend','<option>Sin firmar</option>');
      }
      firmaSel.value = data.firma || "Sin firmar";
      document.getElementById("alcohol").value = data.alcohol || "NO";
      document.getElementById("valorMultaAccidente").value = data.valorMulta || 0;

      editingFallo = data.fallo || "";

      const container = document.getElementById("participantesContainer");
      container.innerHTML = "";
      if (data.participantes?.length){
        data.participantes.forEach(p=>{
          const div = document.createElement("div");
          div.className="d-flex gap-2 align-items-start mb-2";
          div.innerHTML = `
            <input type="text" placeholder="Nombre" class="form-control participante-nombre" value="${p.nombre||''}" required>
            <input type="text" placeholder="DNI" class="form-control participante-dni" value="${p.dni||''}" required>
            <input type="text" placeholder="Dominio" class="form-control participante-dominio" value="${p.dominio||''}" required>
            <button type="button" class="btn btn-sm btn-outline-danger btnEliminar" title="Quitar"><i class="bi bi-x-lg"></i></button>`;
          container.appendChild(div);
          div.querySelector(".btnEliminar").addEventListener("click",()=>div.remove());
        });
      }

      document.getElementById("accidenteForm").scrollIntoView({ behavior:"smooth", block:"start" });
    }

    /* ====== TABLA ====== */
    function updateTable(){
      const tbody = document.querySelector("#accidentesTable tbody");
      tbody.innerHTML = "";

      accidentesData.forEach(item=>{
        const tr = document.createElement("tr");
        tr.className = (item.estado||"").toLowerCase().replace(/ /g,"-");

        tr.innerHTML = `
          <td>${item.numero||""}</td>
          <td>${item.nombre||""}${item.participantes?.length? `<div class="participantes-list">${item.participantes.map(p=>p.nombre).join("<br>")}</div>`:""}</td>
          <td>${item.dni||""}${item.participantes?.length? `<div class="participantes-list">${item.participantes.map(p=>p.dni).join("<br>")}</div>`:""}</td>
          <td>${item.fecha||""}</td>
          <td>${item.lugar||""}</td>
          <td>${item.dominio||""}${item.participantes?.length? `<div class="participantes-list">${item.participantes.map(p=>p.dominio).join("<br>")}</div>`:""}</td>
          <td>${item.fechaAudiencia||""}</td>
          <td>${item.asignada||""}</td>
          <td>${item.tipo||""}</td>
          <td>${item.estado||""}</td>
          <td>${badgeFirma(item.firma||"")}</td>
          <td>${item.valorMulta||0}</td>
          <td>${item.fallo? `<a href="javascript:void(0)" class="link-pdf">PDF</a>` : ""}</td>
          <td class="actions">
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-primary btn-edit" title="Editar"><i class="bi bi-pencil-square"></i></button>
              <button class="btn btn-outline-danger btn-del" title="Borrar"><i class="bi bi-trash"></i></button>
            </div>
          </td>`;

        if(item.fallo){
          tr.querySelector(".link-pdf").addEventListener("click", ()=>{
            const modal = document.createElement("div");
            modal.style.cssText = `position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;z-index:1200;`;
            modal.innerHTML = `
              <button style="position:absolute;top:10px;right:10px;background:#fff;border:none;border-radius:6px;padding:4px 8px;cursor:pointer">×</button>
              <iframe src="${item.fallo}" style="width:90%;height:90%;border:none;background:white;border-radius:8px;"></iframe>`;
            modal.querySelector("button").onclick = ()=>modal.remove();
            document.body.appendChild(modal);
          });
        }

        tr.querySelector(".btn-edit").addEventListener("click", ()=>editarRegistro("accidentes", item.id));
        tr.querySelector(".btn-del").addEventListener("click", ()=>eliminarRegistro("accidentes", item.id));

        tbody.appendChild(tr);
      });
    }

    /* ====== BÚSQUEDA GLOBAL (cards) ====== */
    async function buscarRegistros(){
      const searchTerm = document.getElementById("searchInput").value.trim().toLowerCase();
      const resultsDiv = document.getElementById("searchResults");
      resultsDiv.innerHTML = "<p class='text-muted'>Buscando…</p>";

      const accidentsSnap = await getDocs(collection(db,"accidentes"));
      const accidentes = [];
      accidentsSnap.forEach(d => accidentes.push(d.data()));

      const resultados = accidentes.filter(a =>
        (a.dni||"").toLowerCase() === searchTerm ||
        (a.dominio||"").toLowerCase() === searchTerm ||
        (a.numero||"").toLowerCase() === searchTerm ||
        (a.estado||"").toLowerCase() === searchTerm ||
        (a.participantes||[]).some(p =>
          (p.dni||"").toLowerCase()===searchTerm || (p.dominio||"").toLowerCase()===searchTerm
        )
      );

      let html = "";
      if (resultados.length){
        resultados.forEach(acc=>{
          const firmaChip = (acc.firma||"").toLowerCase()==="sin firmar"
            ? `<span class="chip chip-muted"><i class="bi bi-pencil-slash"></i> Sin firmar</span>`
            : `<span class="chip chip-ok"><i class="bi bi-check2-circle"></i> ${acc.firma||"—"}</span>`;

          const partTxt = (acc.participantes?.length)
            ? `<br><strong>Participantes:</strong> ${acc.participantes.map(p=>`${p.nombre} (DNI: ${p.dni}, Dominio: ${p.dominio})`).join(", ")}`
            : "";

          html += `
            <div class="card card-elev p-3 mb-2">
              <div><strong>Accidente:</strong> ${acc.numero} — ${acc.nombre} — ${acc.dni}</div>
              <div><strong>Estado:</strong> ${acc.estado} — <strong>Dominio:</strong> ${acc.dominio||"—"}</div>
              <div><strong>Asignada:</strong> ${acc.asignada||"—"} — <strong>Audiencia:</strong> ${acc.fechaAudiencia||"—"} ${acc.horaAudiencia?`<strong>${acc.horaAudiencia}</strong>`:""}</div>
              <div><strong>Firma:</strong> ${firmaChip} — <span class="${(acc.alcohol||'NO')==='SI'?'text-danger fw-bold':''}">Alcohol: ${acc.alcohol||'NO'}</span> — <strong>Multa: $${acc.valorMulta||0}</strong>${partTxt}</div>
              <div class="mt-2 d-flex gap-2">
                <button class="btn btn-success btn-sm pay-button"
                  data-numero="${acc.numero||''}"
                  data-nombre="${acc.nombre||''}"
                  data-dni="${acc.dni||''}"
                  data-fecha="${acc.fechaAudiencia||acc.fecha||''}"
                  data-valor="${acc.valorMulta||0}">
                  <i class="bi bi-credit-card"></i> Pagar
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="location.reload()"><i class="bi bi-x-circle"></i> Cancelar</button>
              </div>
            </div>`;
        });
      } else {
        html = "<p class='text-muted'>No se encontraron registros.</p>";
      }
      resultsDiv.innerHTML = html;
    }
    window.buscarRegistros = buscarRegistros;

    /* ====== FORM HANDLERS ====== */
    document.addEventListener("DOMContentLoaded", ()=>{
      document.getElementById("scrollToForm").addEventListener("click", ()=>{
        document.getElementById("accidenteForm").scrollIntoView({behavior:"smooth"});
      });

      const btnAgregar = document.getElementById("btnAgregarParticipante");
      btnAgregar?.addEventListener("click", ()=>{
        const container = document.getElementById("participantesContainer");
        const div = document.createElement("div");
        div.className = "d-flex gap-2 align-items-start mb-2";
        div.innerHTML = `
          <input type="text" placeholder="Nombre" class="form-control participante-nombre" required>
          <input type="text" placeholder="DNI" class="form-control participante-dni" required>
          <input type="text" placeholder="Dominio" class="form-control participante-dominio" required>
          <button type="button" class="btn btn-sm btn-outline-danger btnEliminar" title="Quitar"><i class="bi bi-x-lg"></i></button>`;
        container.appendChild(div);
        div.querySelector(".btnEliminar").addEventListener("click",()=>div.remove());
      });

      document.getElementById("accidenteForm").addEventListener("submit", async e=>{
        e.preventDefault();

        const participantes = [];
        document.querySelectorAll("#participantesContainer .d-flex").forEach(row=>{
          participantes.push({
            nombre: row.querySelector(".participante-nombre").value.trim(),
            dni: row.querySelector(".participante-dni").value.trim(),
            dominio: row.querySelector(".participante-dominio").value.trim(),
          });
        });

        const falloFile = document.getElementById("falloPdf").files[0];

        const baseAcc = {
          numero: document.getElementById("numeroAccidente").value.trim(),
          nombre: document.getElementById("nombreAccidente").value.trim(),
          dni: document.getElementById("dniAccidente").value.trim(),
          fecha: document.getElementById("fechaAccidente").value,
          lugar: document.getElementById("lugarAccidente").value.trim(),
          dominio: document.getElementById("dominioAccidente").value.trim(),
          fechaAudiencia: document.getElementById("fechaAudiencia").value,
          horaAudiencia: document.getElementById("horaAudiencia").value,
          asignada: document.getElementById("asignadaA").value,
          tipo: document.getElementById("tipoAccidente").value,
          estado: document.getElementById("estadoAccidente").value,
          firma: document.getElementById("firma").value,
          alcohol: document.getElementById("alcohol").value,
          valorMulta: Number(document.getElementById("valorMultaAccidente").value||0),
          fallo: editingId ? editingFallo : "",
          participantes
        };

        if (falloFile){
          const reader = new FileReader();
          reader.onload = async ev=>{
            await guardarAccidente({ ...baseAcc, fallo: ev.target.result });
            e.target.reset();
            document.getElementById("participantesContainer").innerHTML="";
          };
          reader.readAsDataURL(falloFile);
        }else{
          await guardarAccidente(baseAcc);
          e.target.reset();
          document.getElementById("participantesContainer").innerHTML="";
        }
      });

      document.getElementById("btnExportAccidentes").addEventListener("click", ()=>{
        const table = document.getElementById("accidentesTable");
        const headers = [];
        const data = [];
        const excludeHeads = new Set(["DNI","LUGAR","FALLO","ACCIONES"]);
        const ths = table.querySelectorAll("thead th");
        const excludeIdx = [];
        ths.forEach((th, idx)=>{
          const txt = th.innerText.trim().toUpperCase();
          if(excludeHeads.has(txt)){ excludeIdx.push(idx); } else { headers.push(txt); }
        });
        data.push(headers);

        table.querySelectorAll("tbody tr").forEach(tr=>{
          const row = [];
          tr.querySelectorAll("td").forEach((td, idx)=>{
            if(!excludeIdx.includes(idx)){
              row.push(td.innerText.replace(/\s+/g,' ').trim());
            }
          });
          data.push(row);
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Accidentes');
        XLSX.writeFile(wb, 'Accidentes.xlsx');
      });

      document.getElementById("btnBuscarAccidente").addEventListener("click", ()=>{
        const termino = document.getElementById("filtroAccidentes").value.toLowerCase().trim();
        const filas = document.querySelectorAll("#accidentesTable tbody tr");
        document.getElementById("btnVolver").classList.remove("d-none");
        filas.forEach(f=>{ f.style.display = f.innerText.toLowerCase().includes(termino) ? "" : "none"; });
      });
      document.getElementById("btnVolver").addEventListener("click", ()=>{
        document.querySelectorAll("#accidentesTable tbody tr").forEach(f=>f.style.display="");
        document.getElementById("filtroAccidentes").value="";
        document.getElementById("btnVolver").classList.add("d-none");
      });
    });

    /* ====== AUDIENCIAS HOY (toast) ====== */
    async function verificarAudienciasHoy(){
      const hoy = new Date().toISOString().split("T")[0];
      const q = query(collection(db,"accidentes"));
      const snapshot = await getDocs(q);
      const audiencias = [];
      snapshot.forEach(d=>{
        const a = d.data();
        if (a.fechaAudiencia === hoy && a.asignada){
          audiencias.push({ numero: a.numero||"Sin número", asignadaA: a.asignada||"—", hora: a.horaAudiencia||"—" });
        }
      });

      if(audiencias.length){
        const alerta = document.getElementById("alertaAudiencia");
        const lista = document.getElementById("listaAudiencias");
        const sonido = document.getElementById("alertaSonido");
        lista.innerHTML = "";
        audiencias.forEach(item=>{
          const li = document.createElement("li");
          li.innerHTML = `<span class="me-1">✅</span> <strong>${item.numero}</strong> — <em>${item.hora}h</em> — <em>${item.asignadaA}</em>`;
          lista.appendChild(li);
        });
        alerta.style.display="block";         // muestra toast flotante
        sonido.play().catch(()=>{});
        document.getElementById("cerrarAlerta").addEventListener("click",()=> alerta.style.display="none");
      }
    }

    /* ====== PDF PAGO ====== */
    async function generarPDF(acc){
      const doc = new jsPDF();
      const logoBase64 = await fetch("logo.png").then(res=>res.blob())
        .then(b=>new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(b); }));

      doc.addImage(logoBase64, "PNG", 15, 10, 20, 20);
      doc.setFont("helvetica","bold"); doc.setFontSize(18);
      doc.text("Municipalidad de Maipú", 105, 15, {align:"center"});
      doc.setFontSize(14);
      doc.text("Juzgado Vial Zona Este", 105, 25, {align:"center"});
      doc.setLineWidth(.5); doc.line(15,32,195,32);

      let y=45; doc.setFontSize(12);
      doc.text(`Número de Accidente: ${acc.numero}`, 20, y); y+=10;
      doc.text(`Nombre: ${acc.nombre}`, 20, y); y+=10;
      doc.text(`DNI: ${acc.dni}`, 20, y); y+=10;
      doc.text(`Fecha Audiencia: ${acc.fecha||"—"}`, 20, y); y+=10;
      doc.text(`Valor Multa: $${acc.valorMulta||0}`, 20, y); y+=10;
      doc.text(`Fecha de Pago: ${new Date().toLocaleDateString()}`, 20, y); y+=5;

      const linkPago = "https://mpago.la/XXXXXXXX";
      const qrURL = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(linkPago)}`;
      const qrImg = await fetch(qrURL).then(res=>res.blob())
        .then(b=>new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(b); }));
      doc.text("Escanee para pagar:", 105, y+20, {align:"center"});
      doc.addImage(qrImg, "PNG", (210-60)/2, y+25, 60, 60);

      window.open(doc.output("bloburl"), "_blank");
    }

    document.addEventListener("click", e=>{
      if (e.target.closest(".pay-button")){
        const btn = e.target.closest(".pay-button");
        Swal.fire({
          title:"Datos del Conductor",
          html: `
            <input id="nombre" class="swal2-input" placeholder="Nombre completo" value="${btn.dataset.nombre||''}">
            <input id="dni" class="swal2-input" placeholder="DNI" value="${btn.dataset.dni||''}">
          `,
          confirmButtonText:"Generar comprobante",
          showCancelButton:true,
          cancelButtonText:"Cancelar",
          preConfirm: ()=>{
            const nombre = document.getElementById("nombre").value.trim();
            const dni = document.getElementById("dni").value.trim();
            if(!nombre || !dni){ Swal.showValidationMessage("Debe completar nombre y DNI"); return false; }
            return {nombre,dni};
          }
        }).then(result=>{
          if(result.isConfirmed){
            const acc = {
              numero: btn.dataset.numero,
              nombre: result.value.nombre,
              dni: result.value.dni,
              fecha: btn.dataset.fecha,
              valorMulta: btn.dataset.valor
            };
            generarPDF(acc);
          }
        });
      }
    });

    /* ===== INIT ===== */
    document.addEventListener("DOMContentLoaded", async ()=>{
      await cargarDatos();
      await verificarAudienciasHoy();
    });
  </script>
</body>
</html>
