<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Notificaciones de Audiencias</title>
  <link rel="icon" href="logo.png" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Export PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --blue:#0a9ad9;    /* azul logo */
      --green:#53b44c;   /* verde logo */
      --orange:#f59e0b;  /* naranja logo */
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#64748b;
      --border:#e5e7eb;
    }
    html,body{ background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; margin:0; }
    *{ box-sizing:border-box; }

    /* ===== Header ===== */
    .sys-header{
      position: sticky; top:0; z-index: 50;
      background: linear-gradient(90deg, var(--blue), var(--green));
      box-shadow: 0 6px 16px rgba(0,0,0,.15);
      color:#fff;
    }
    .header-row{
      display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:1rem;
      max-width:1200px; margin:0 auto; padding:.6rem 1rem;
    }
    .brand{ display:flex; align-items:center; gap:.6rem; font-weight:800; letter-spacing:.2px; color:#fff; text-decoration:none; }
    .brand img{ width:34px; height:34px; background:#fff; border-radius:8px; padding:3px; object-fit:contain; }
    .title-full{ display:inline; }
    .title-short{ display:none; }
    .header-actions{ justify-self:end; display:flex; gap:.5rem; flex-wrap:wrap; }
    .btn{ padding:8px 14px; border:none; border-radius:10px; cursor:pointer; font-weight:700; }
    .btn-outline{ background:transparent; color:#fff; border:1px solid #ffffffb3; }
    .btn-outline:hover{ background:#ffffff1a; }
    .btn-blue{ background:#0288d1; color:#fff; }
    .btn-blue:hover{ background:#0277bd; }
    .btn-green{ background:#16a34a; color:#fff; }
    .btn-green:hover{ background:#14843f; }
    .btn-red{ background:#e53935; color:#fff; }
    .btn-ghost{ background:#eef2f7; color:#0f172a; }

    .container{ max-width:1200px; margin: 16px auto; padding: 0 16px; }

    /* ===== Toolbar ===== */
    .toolbar{
      display:grid; grid-template-columns: repeat(8, 1fr); gap:10px; align-items:end; margin: 10px 0 16px;
    }
    .toolbar label{ font-size:12px; color:#0f172a; font-weight:800; display:flex; flex-direction:column; gap:6px; }
    .toolbar input[type="text"], .toolbar select{
      border:1px solid var(--border); border-radius:10px; padding:9px 10px; background:#fff; color:#111827;
    }
    .t-span2{ grid-column: span 2; }
    .t-span3{ grid-column: span 3; }
    .t-span4{ grid-column: span 4; }

    /* ===== Cards ===== */
    .grid{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:14px;
    }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px;
      box-shadow:0 6px 18px rgba(2,19,32,.06); position:relative;
      display:flex; flex-direction:column; gap:10px; min-height:180px;
    }
    .title{ font-weight:900; font-size:15px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .tag{
      display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px;
      background:#eef2f7; color:#111827; border:1px dashed #cbd5e1;
    }
    .muted{ color:var(--muted); font-size:12px; }

    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .phone{
      display:flex; gap:6px; align-items:center; flex-wrap:nowrap;
    }
    .phone input{
      border:1px solid var(--border); border-radius:10px; padding:9px 10px; background:#fff; color:#111827;
    }
    .cc{ width:90px; }
    .num{ width:180px; }
    .actions{ display:flex; gap:6px; flex-wrap:wrap; }
    .btn-xs{ padding:6px 10px; border-radius:8px; font-size:12px; }

    .empty{ padding:18px; text-align:center; color:var(--muted); border:1px dashed var(--border); border-radius:12px; background:#fff; }

    /* ===== Responsive ===== */
    @media (max-width: 1024px){ .grid{ grid-template-columns:1fr 1fr; } .toolbar{ grid-template-columns: repeat(4, 1fr); } .t-span4{ grid-column: span 4; } }
    @media (max-width: 640px){
      .grid{ grid-template-columns:1fr; }
      .toolbar{ grid-template-columns:1fr 1fr; }
      .t-span2, .t-span3, .t-span4{ grid-column: span 2; }
      .num{ width:100%; }
      /* Header m√≥vil: logo + ‚ÄúNotificaciones‚Äù + 2 botones */
      .title-full{ display:none; }
      .title-short{ display:inline; font-weight:900; }
    }
     .sys-header{
    position: sticky; top:0; z-index: 50;
    background: linear-gradient(90deg, var(--blue), var(--green));
    box-shadow: 0 6px 16px rgba(0,0,0,.15);
    color:#fff;
  }

  .header-row{
    display:flex;
    justify-content:space-between; /* distribuye logo izquierda, botones derecha */
    align-items:center;
    max-width:1200px;
    margin:0 auto;
    padding:.6rem 1rem;
    flex-wrap:wrap;
  }

  .brand{
    display:flex; align-items:center; gap:.6rem;
    font-weight:800; color:#fff; text-decoration:none;
  }

  .brand img{
    width:34px; height:34px; border-radius:8px;
    background:#fff; padding:3px; object-fit:contain;
  }

  .title-full{ display:inline; }
  .title-short{ display:none; }

  .header-actions{
    display:flex;
    gap:.5rem;
    flex-wrap:wrap;
    margin-left:auto; /* asegura que se pegue a la derecha */
  }

  .btn{ padding:8px 14px; border:none; border-radius:10px; cursor:pointer; font-weight:700; }
  .btn-outline{ background:transparent; color:#fff; border:1px solid #ffffffb3; }
  .btn-outline:hover{ background:#ffffff1a; }
  .btn-blue{ background:#0288d1; color:#fff; }
  .btn-green{ background:#16a34a; color:#fff; }

  /* ===== Responsive ===== */
  @media (max-width:640px){
    .header-row{
      flex-direction:column;
      align-items:flex-start;
      gap:.6rem;
    }
    .header-actions{
      justify-content:center;
      width:100%;
      margin-left:0;
    }
    .title-full{ display:none; }
    .title-short{ display:inline; font-weight:900; }
  }
  
  </style>
</head>
<body>

<header class="sys-header">
  <div class="header-row">
    <a href="juzgado.html" class="brand">
      <img src="logo.png" alt="Logo">
      <span class="title-full">Juzgado Vial Maip√∫ ‚Äî Notificaciones</span>
      <span class="title-short">Juzgado Vial Maip√∫ ‚Äî Notificaciones</span>
    </a>
    <div class="header-actions">
      <a href="juzgado.html"><button class="btn btn-outline">‚¨Ö Volver</button></a>
      <button id="btnPDF" class="btn btn-green">üìÑ Descargar PDF</button>
    </div>
  </div>
</header>
<div class="container">

  <!-- ===== Toolbar filtros ===== -->
  <form class="toolbar" onsubmit="return false">
    <label class="t-span2">Ver
      <select id="nfRango">
        <option value="hoy">Audiencias de HOY</option>
        <option value="7">Pr√≥ximos 7 d√≠as</option>
        <option value="30" selected>Pr√≥ximos 30 d√≠as</option>
        <option value="todos">Todas con fecha</option>
      </select>
    </label>

    <label class="t-span3">Buscar (DNI / Nombre / N¬∫)
      <input type="text" id="nfBuscar" placeholder="Ej: 36222333 o 01/2025 o P√©rez">
    </label>

    <label>Prefijo pa√≠s
      <input type="text" id="nfCC" value="+54">
    </label>

    <div class="t-span2" style="display:flex; gap:8px; align-items:end;">
      <button id="nfAplicar" class="btn btn-blue" type="button">Aplicar</button>
      <button id="nfLimpiar" class="btn btn-ghost" type="button">Limpiar</button>
    </div>
  </form>

  <!-- ===== Lista ===== -->
  <div id="cards" class="grid">
    <div class="empty">Cargando notificaciones‚Ä¶</div>
  </div>
</div>

<!-- ===== APP ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  /* ===== FIREBASE ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyCLhhSoQ9gljKTPvWVZVGI3G8dU9dmi53Y",
    authDomain: "mi-juzgado-447a4.firebaseapp.com",
    projectId: "mi-juzgado-447a4",
    storageBucket: "mi-juzgado-447a4.appspot.com",
    messagingSenderId: "276360645206",
    appId: "1:276360645206:web:e6c016d29d98add7bec9f7"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* ===== State ===== */
  let accidentes = [];
  let currentRows = []; // lo que se muestra (para PDF)

  const cards = document.getElementById("cards");
  const nfRango  = document.getElementById("nfRango");
  const nfBuscar = document.getElementById("nfBuscar");
  const nfCC     = document.getElementById("nfCC");

  /* ===== Utils ===== */
  const toDateOnly = (d)=> new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const fmtDMY = (d)=> [String(d.getDate()).padStart(2,"0"), String(d.getMonth()+1).padStart(2,"0"), d.getFullYear()].join("/");

  // üëâ PARSEO LOCAL: evita el ‚Äúd√≠a menos‚Äù (no usa UTC interno del Date ISO string)
  function parseDateAny(s){
    if(!s) return null;
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)){ // YYYY-MM-DD (input date)
      const [y,m,d]=s.split("-").map(Number);
      return new Date(y, m-1, d);
    }
    if(/^\d{2}\/\d{2}\/\d{4}$/.test(s)){ // DD/MM/YYYY por si hubiera
      const [d,m,y]=s.split("/").map(Number);
      return new Date(y, m-1, d);
    }
    const d = new Date(s);
    return isNaN(d) ? null : new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }

  function normalizePhone(raw, cc){
    let n=(raw||"").toString().trim();
    if(!n) return "";
    n=n.replace(/[^\d+]/g,"");
    if(n.startsWith("+")) return n;
    if(n.startsWith("0")) n=n.slice(1);
    if(n.startsWith("15")) n=n.slice(2);
    return (cc||"").replace(/\s/g,"")+n;
  }
  function includesQ(s, q){ return (s||"").toString().toLowerCase().includes(q); }

  function composeMessage(r){
    const dObj = parseDateAny(r.fecha);
    const fecha = dObj ? fmtDMY(dObj) : "‚Äî";
    const hora  = r.hora ? `${r.hora} hs` : "";
    return `*Juzgado de Tr√°nsito Zona Este de la Municipalidad de Maip√∫* ‚Äî Accidente N¬∞ *${r.numero}* (caratulado *${r.nombre}*).
Se notifica que debe concurrir a la AUDIENCIA el d√≠a *${fecha}* a las *${hora}*, en Ruta Provincial 50 N¬∞4359, Rodeo del Medio (Maip√∫).
Presente DNI y documentaci√≥n del rodado. Si no puede asistir, un familiar o representante legal podr√° presentarse con certificado m√©dico (Arts. 109 y 113 Ley de Tr√°nsito).`;
  }

  /* ===== Build recipients (pendientes) ===== */
  function buildRecipients(){
    const today = toDateOnly(new Date());
    const q = (nfBuscar.value||"").toLowerCase();
    const range = nfRango.value;

    const upTo = range==="hoy" ? today
               : range==="7" ? new Date(today.getFullYear(), today.getMonth(), today.getDate()+7)
               : range==="30" ? new Date(today.getFullYear(), today.getMonth(), today.getDate()+30)
               : null;

    const out = [];
    accidentes.forEach(a=>{
      if(a.notificado===true) return;

      // fecha v√°lida para audiencias (PARSEO LOCAL)
      const d = parseDateAny(a.fechaAudiencia);
      if(!d) return;
      const dOnly = toDateOnly(d);
      if(range==="hoy" && (+dOnly!==+today)) return;
      if(upTo && (dOnly<today || dOnly>upTo)) return;

      const baseMatch = (str)=> includesQ(str, q);
      const matchDoc = !q || baseMatch(a.numero)||baseMatch(a.nombre)||baseMatch(a.dni)||baseMatch(a.dominio);

      // Titular
      if(a.notificado_titular!==true){
        const titular = {
          id:a.id, idx:null, rol:"Titular",
          numero:a.numero||"‚Äî", nombre:a.nombre||"‚Äî", dni:a.dni||"‚Äî",
          fecha:a.fechaAudiencia, hora:a.horaAudiencia||"", asignada:a.asignada||"‚Äî",
          telefono:a.telefono||""
        };
        if(matchDoc || baseMatch(titular.nombre) || baseMatch(titular.dni)) out.push(titular);
      }

      // Participantes
      (a.participantes||[]).forEach((p,idx)=>{
        if(p?.notificado===true) return;
        const rec = {
          id:a.id, idx, rol:"Participante",
          numero:a.numero||"‚Äî", nombre:p?.nombre||"‚Äî", dni:p?.dni||"‚Äî",
          fecha:a.fechaAudiencia, hora:a.horaAudiencia||"", asignada:a.asignada||"‚Äî",
          telefono:p?.telefono||""
        };
        if(matchDoc || baseMatch(rec.nombre) || baseMatch(rec.dni)) out.push(rec);
      });
    });

    // ordenar por fecha (PARSEO LOCAL) y hora
    out.sort((r1,r2)=> {
      const d1 = parseDateAny(r1.fecha) || new Date(0);
      const d2 = parseDateAny(r2.fecha) || new Date(0);
      return (+d1 - +d2) || (r1.hora||"").localeCompare(r2.hora||"");
    });
    return out;
  }

  /* ===== Render ===== */
  function render(){
    const rows = buildRecipients();
    currentRows = rows;
    cards.innerHTML = "";

    if(!rows.length){
      cards.innerHTML = `<div class="empty">No hay notificaciones pendientes para el criterio seleccionado.</div>`;
      return;
    }

    const ccDefault = nfCC.value || "+54";

    rows.forEach((r)=>{
      const card = document.createElement("div");
      card.className = "card";

      const fechaTxt = (()=>{ const d=parseDateAny(r.fecha); return d ? fmtDMY(d) : "‚Äî"; })();

      card.innerHTML = `
        <div class="title">
          <span class="tag"># ${r.numero}</span>
          <span><strong>${r.nombre}</strong> <span class="tag">${r.rol}</span></span>
        </div>

        <div class="row">
          <div><strong>${fechaTxt}</strong>${r.hora?` ‚Äî ${r.hora} hs`:""}</div>
          <div class="muted">Asignada: ${r.asignada||"‚Äî"}</div>
        </div>

        <div class="row">
          <div class="phone">
            <input class="cc" type="text" value="${ccDefault}">
            <input class="num" type="text" placeholder="Ej: 2616123456" value="${r.telefono||""}">
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-blue btn-xs act-wa">WhatsApp</button>
          <button class="btn btn-green btn-xs act-copy">Copiar</button>
          <button class="btn btn-blue btn-xs act-save">Guardar</button>
          <button class="btn btn-red btn-xs act-done">Marcar notificado</button>
        </div>
      `;

      const ccInput  = card.querySelector(".cc");
      const numInput = card.querySelector(".num");

      // WhatsApp
      card.querySelector(".act-wa").addEventListener("click", ()=>{
        const phone = normalizePhone(numInput.value, ccInput.value);
        if(!phone){ alert("Carg√° un tel√©fono v√°lido."); return; }
        const msg = encodeURIComponent(composeMessage(r));
        window.open(`https://wa.me/${phone.replace(/\+/g,"")}?text=${msg}`,"_blank");
      });

      // Copiar
      card.querySelector(".act-copy").addEventListener("click", async ()=>{
        try{ await navigator.clipboard.writeText(composeMessage(r)); alert("Mensaje copiado."); }catch{ alert("No se pudo copiar."); }
      });

      // Guardar tel√©fono
      card.querySelector(".act-save").addEventListener("click", async ()=>{
        const raw = numInput.value.trim();
        if(!r.id){ alert("No se puede guardar: falta ID del documento."); return; }
        try{
          const ref = doc(db, "accidentes", r.id);
          if(r.idx===null){
            await updateDoc(ref, { telefono: raw });
            const acc = accidentes.find(a=>a.id===r.id); if(acc) acc.telefono = raw;
          }else{
            const acc = accidentes.find(a=>a.id===r.id);
            const parts = (acc.participantes||[]).map((p,idx)=> idx===r.idx ? ({...p, telefono: raw}) : p );
            await updateDoc(ref, { participantes: parts });
            if(acc) acc.participantes = parts;
          }
          alert("Tel√©fono guardado.");
        }catch(e){ console.error(e); alert("No se pudo guardar. Ver reglas de Firestore."); }
      });

      // Marcar notificado (elimina de la lista)
      card.querySelector(".act-done").addEventListener("click", async ()=>{
        if(!confirm("¬øConfirmar que esta persona ya fue notificada?")) return;
        try{
          const ref = doc(db, "accidentes", r.id);
          if(r.idx===null){
            await updateDoc(ref, { notificado_titular: true });
            const acc = accidentes.find(a=>a.id===r.id); if(acc) acc.notificado_titular = true;
          }else{
            const acc = accidentes.find(a=>a.id===r.id);
            const parts = (acc.participantes||[]).map((p,idx)=> idx===r.idx ? ({...p, notificado: true}) : p );
            await updateDoc(ref, { participantes: parts });
            if(acc) acc.participantes = parts;
          }
          // Si todos notificados -> set notificado:true
          const acc = accidentes.find(a=>a.id===r.id);
          const titularDone = acc?.notificado_titular===true || !acc?.nombre;
          const parts = acc?.participantes||[];
          const allPartsDone = parts.every(p=>p?.notificado===true);
          if(titularDone && allPartsDone){
            await updateDoc(ref, { notificado: true });
            acc.notificado = true;
          }
          // sacar tarjeta
          card.remove();
          if(!cards.children.length){
            cards.innerHTML = `<div class="empty">No hay notificaciones pendientes para el criterio seleccionado.</div>`;
          }
        }catch(e){ console.error(e); alert("No se pudo marcar como notificado."); }
      });

      cards.appendChild(card);
    });
  }

  /* ===== PDF ===== */
  document.getElementById("btnPDF").addEventListener("click", async ()=>{
    const { jsPDF } = window.jspdf;
    if(!currentRows.length){ alert("No hay mensajes para generar PDF."); return; }
    const pdf = new jsPDF("p","mm","a4");
    const margin = 12, maxW = 190;

    currentRows.forEach((r,idx)=>{
      if(idx>0) pdf.addPage();
      pdf.setFont("helvetica","bold"); pdf.setFontSize(16);
      pdf.text("Notificaci√≥n de Audiencia", margin, 16);
      pdf.setFontSize(12); pdf.setFont("helvetica","normal");

      const text = composeMessage(r);
      const lines = pdf.splitTextToSize(text, maxW);
      pdf.text(lines, margin, 28);
    });

    pdf.save("notificaciones_audiencias.pdf");
  });

  /* ===== Toolbar events ===== */
  document.getElementById("nfAplicar").addEventListener("click", render);
  document.getElementById("nfLimpiar").addEventListener("click", ()=>{
    nfBuscar.value=""; nfRango.value="30"; render();
  });

  /* ===== Init ===== */
  async function init(){
    const snap = await getDocs(collection(db,"accidentes"));
    accidentes = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    render();
  }
  init();
</script>
</body>
</html>
